# Reconciliation

**Goal:** Deterministic join between rail evidence and on-chain events via `settlementRef` and `settlementNetwork`.

## Demo flow

1. `npm run demo` — simulates DvP, emits events, and writes `out/recon.report.json`.
2. `npm run validate:recon` — validates the recon report against [`specs/recon.report.schema.json`](specs/recon.report.schema.json).
3. Inspect `out/recon.report.json` to confirm `matched[]` vs `breaks[]`.

### Sample inputs

- Rails CSV: [`ops/recon/rails.sample.csv`](../ops/recon/rails.sample.csv)
- Events JSON: `out/events.sample.json` (generated by the demo)
- Recon report: `out/recon.report.json`

### Report shape

```json
{
  "generatedAt": "2024-09-30T23:30:00Z",
  "matched": [
    {
      "settlementRef": "2025-10-15/MsgId:ABC123",
      "amount": 100000,
      "currency": "USD"
    }
  ],
  "breaks": []
}
```

## Production considerations

- **Normalization:** uppercase refs, strip whitespace, harmonize currency minor units.
- **Tolerance bands:** capture near-miss matches (FX slippage, rounding).
- **Duplicates:** flag duplicate `settlementRef` per rail/investor pair.
- **Attestations:** persist immutable hashes of bank statements & recon outputs.
- **Audit trail:** include user/time metadata for manual overrides.

## Extending automation

- Export recon metrics to monitoring (matched ratio, outstanding breaks).
- Notify ops when `breaks[]` non-empty post-cutoff.
- Retain historical reports for regulators/auditors.
